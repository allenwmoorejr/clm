"use client";import {useEffect,useMemo,useRef,useState} from 'react';import Link from 'next/link';type LiveResponse={live:boolean;videoId?:string;latestId?:string};function fmt(s:number){const m=Math.floor(s/60),x=Math.floor(s%60);return `${m}:${x.toString().padStart(2,'0')}`}export default function WatchPage(){const [data,setData]=useState<LiveResponse|null>(null);const [show,setShow]=useState(false);const [progress,setProgress]=useState(0);const [resume,setResume]=useState<number|null>(null);const t=useRef<any>(null);useEffect(()=>{fetch('/api/live').then(r=>r.json()).then(setData).catch(()=>setData({live:false}))},[]);const videoId=data?.live?data.videoId:data?.latestId;useEffect(()=>{if(!videoId)return;const raw=localStorage.getItem(`yt-progress-${videoId}`);if(raw){try{const v=JSON.parse(raw);if(typeof v.seconds==='number')setResume(v.seconds)}catch{}}},[videoId]);useEffect(()=>{if(!show||!videoId)return;t.current=setInterval(()=>{setProgress(p=>{const n=p+1;if(n%5===0)localStorage.setItem(`yt-progress-${videoId}`,JSON.stringify({seconds:n,at:Date.now()}));return n})},1000);return()=>clearInterval(t.current)},[show,videoId]);const share=useMemo(()=>{if(!videoId)return'';const s=resume??progress;return `https://www.youtube.com/watch?v=${videoId}${s>0?`&t=${s}s`:''}`},[videoId,progress,resume]);return(<section className='container py-16'><h1>{data?.live?'We’re Live Now':'Watch'}</h1><p className='text-white/70 mt-2'>{data?.live?'Thanks for worshiping with us!':'We’re not live right now — enjoy the latest message below.'}</p><div className='card overflow-hidden mt-8 relative'><div className='aspect-video relative'>{!show?(<><img src='/live-preview.jpg' alt='CLM Live Preview' className='w-full h-full object-cover'/><div className='absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent'/><div className='absolute inset-0 flex items-end justify-start'><div className='p-4 md:p-6'><div className='flex flex-wrap gap-3'><a href={videoId?`https://www.youtube.com/watch?v=${videoId}`:`https://www.youtube.com/channel/${process.env.NEXT_PUBLIC_CHANNEL_ID??''}/live`} target='_blank' rel='noreferrer' className='btn-primary'>Watch on YouTube</a>{videoId&&(<button onClick={()=>setShow(true)} className='btn-ghost'>{resume&&resume>15?`Resume in Page (${fmt(resume)})`:'Play in Page'}</button>)}{videoId&&resume&&resume>15&&(<a href={`https://www.youtube.com/watch?v=${videoId}&t=${resume}s`} target='_blank' rel='noreferrer' className='btn-ghost'>Resume on YouTube ({fmt(resume)})</a>)}</div></div></div></>):(<iframe className='w-full h-full' src={`https://www.youtube.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0`} title='CLM Live' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share' allowFullScreen/> )}</div><div className='p-5 border-t border-white/10 flex items-center justify-between flex-wrap gap-3'><div className='flex items-center gap-4'><p className='text-white/90 font-medium'>{data?.live?'Live Stream':'Latest Sermon'}</p>{show&&<span className='text-white/60 text-sm'>Playing — {fmt(progress)}</span>}</div><div className='flex items-center gap-3'>{videoId&&(<button onClick={()=>{navigator.clipboard?.writeText(share)}} className='btn-ghost' title='Copy a link that starts at the current time'>Copy timestamp link</button>)}<Link href='/sermons' className='btn-primary'>Browse Sermons</Link></div></div></div></section>) }